<!DOCTYPE HTML>
<!--
    Strongly Typed 1.0 by HTML5 UP
    html5up.net | @n33co
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
  <meta charset="utf-8">
  <title>Implementing &quot;indexers&quot; in JavaScript - LINQ to Fail</title>
  <meta name="author" content="Aaron Powell">
  <meta name="viewport" content="width=1040" />
  <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Arvo:700" rel="stylesheet" type="text/css" />
  <link href="/css/highlightjs/solarized_light.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery-1.9.1.min.js"></script>
  <script src="/js/jquery.dropotron-1.3.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/skel.min.js"></script>
  <script src="/js/skel-ui.min.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/skel-noscript.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-desktop.css" />
  </noscript>
  <!--[if lte IE 8]><script src="/js/html5shiv.js"></script><![endif]-->

</head>

    <body class="left-sidebar">

        <div id="header-wrapper">
            <div id="header" class="container">
                <h1 id="logo">Implementing "indexers" in JavaScript</h1>
                <h2>10th July 2013</h2>
                <ul class="tags">
    
        <li><a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a></li>
    
</ul>
                <!-- Nav -->
<nav id="nav">
    <ul>
        <li><a class="icon icon-home" href="/"><span>Home</span></a></li>
        <li><a class="icon icon-github" href="https://github.com/aaronpowell"><span>aaronpowell</span></a></li>
        <li><a class="icon icon-twitter" href="http://twitter.com/slace"><span>@slace</span></a></li>
        <li><a class="icon icon-book" href="/about"><span>About Me</span></a></li>
        <li><a class="icon icon-rss" href="/feed"><span>Feed</span></a></li>
    </ul>
</nav>

            </div>
        </div>

        <div id="main-wrapper">
            <div id="main" class="container">
                <div class="row">
                    <div id="sidebar" class="4u">
    <section>
        <ul class="divided">
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">22nd July 2013</span>
                            <h3><a href="/posts/2013-07-22-array-like-objects.html">Array-like objects</a></h3>
                        </header>
                        <p>Just because it looks like a duck, walks like a duck, quacks like a duck doesn&#39;t mean it&#39;s a duck. There&#39;s dangers with making assumptions of your JavaScript objects based on their surface area.</p>
<p>That said, a lot of power can be gleamed by these seemingly innocent assumptions.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">14th July 2013</span>
                            <h3><a href="/posts/2013-07-14-javascript-new-operator.html">The JavaScript new operator</a></h3>
                        </header>
                        <p>Time to revisit something that was overlooked in the last post, the <code>new</code> operator in JavaScript and what it does.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">5th July 2013</span>
                            <h3><a href="/posts/2013-07-05-javascript-binding-currying-and-arrows.html">JavaScript bind, currying and arrow functions</a></h3>
                        </header>
                        <p>After confusing my colleagues with how to invoke functions with a modifided set of arguments at a single time the next evolutionary point was to confuse them with creating functions that are always called with a different state.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">4th July 2013</span>
                            <h3><a href="/posts/2013-07-04-javascript-call-and-apply.html">JavaScript call and apply</a></h3>
                        </header>
                        <p>After having confused one of my colleagues with some code that used the JavaScript <code>apply</code> method and giving them an answer that didn&#39;t leave them completely bemused I thought I&#39;d share my explanation with the world.</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
                <li>
                    <article class="is-excerpt">
                        <header>
                            <span class="date">21st June 2013</span>
                            <h3><a href="/posts/2013-06-21-walking-a-javascript-object.html">Walking a JavaScript object</a></h3>
                        </header>
                        <p>Ever had a path to a path to a property on a JavaScript object that you want to walk? Something along the lines of <code>foo.bar.baz</code>.</p>
<p>Recently I was trying to solve this problem and came across a nifty little trick</p>

                        <div class="tags">
                            
                                <a class="icon icon-tag" href="/tagged/javascript.html"><span>javascript</span></a>
                            
                        </div>
                    </article>
                </li>
            
        </ul>
    </section>
</div>

                    <div id="content" class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <p><a href="https://twitter.com/lzcd">Luke</a> was wanting to know how to implement this C# code as JavaScript:</p>
<pre class="highlighted"><code class="vala"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> {</span>
    <span class="keyword">public</span> <span class="keyword">string</span> Stuff { <span class="keyword">get</span>; <span class="keyword">set</span>; }

    <span class="keyword">public</span> Foo() {

    }

    <span class="keyword">public</span> Foo(<span class="keyword">string</span> stuff) {
        <span class="keyword">this</span>.Stuff = stuff;
    }

    <span class="keyword">public</span> Foo <span class="keyword">this</span>[<span class="keyword">string</span> stuff] {
        <span class="keyword">get</span> {
            <span class="keyword">return</span> <span class="keyword">new</span> Foo(stuff);
        }
    }

    <span class="keyword">public</span> Foo Bar() {
        Console.WriteLine(<span class="string">"Darn tootin'"</span>);
        <span class="keyword">return</span> <span class="keyword">this</span>;
    }
}</code></pre>
<p>Class-implementation aside the interesting part that he was having trouble with was the indexer, basically being able to write this:</p>
<pre class="highlighted"><code class="matlab"><span class="transposed_variable">Console.</span>WriteLine(new Foo()<span class="matrix">["one"]</span><span class="matrix">["two"]</span><span class="matrix">["three"].</span>Bar());</code></pre>
<p>Now what exactly Luke is trying to do I don&#39;t know (and my life is probably safer not knowing) but there&#39;s no point shying away from a problem. </p>
<p>So the syntax above is supported by JavaScript, you can use <code>[]</code> notation on an object but it&#39;s different to C#&#39;s implementation. Since JavaScript objects are really glorified hash bags when you use [&quot;one&quot;] it&#39;s saying you want the property one of the object, like when you do it on a C# dictionary type, and this will be fine assuming you have a one property. The problem here is that we don&#39;t have said property, we&#39;re wanting to intercept them and create them on the fly.</p>
<h2>Simulating indexers with functions</h2>
<p>Some languages support this concept of &#39;method missing&#39; but not JavaScript (<a href="http://soft.vub.ac.be/~tvcutsem/invokedynamic/proxies_tutorial">well not until we get ES6 proxies</a>) so we need to look at another idea… functions. So we could design something that allows us to write this:</p>
<pre class="highlighted"><code class="avrasm">new Foo()<span class="preprocessor">.make</span>(<span class="string">"one"</span>)<span class="preprocessor">.make</span>(<span class="string">"two"</span>)<span class="preprocessor">.make</span>(<span class="string">"three"</span>)<span class="preprocessor">.Bar</span>()<span class="comment">;</span></code></pre>
<p>But that&#39;s kind of verbose isn&#39;t it? We&#39;ve got this extra make method that we have to call, we&#39;re still using a new operator, really there&#39;s got to be some nicer way which we could do this… right?</p>
<h2>Functions that return functions containing functions</h2>
<p>Let&#39;s make it so we can drop the make part of the above API, so we are now doing this:</p>
<pre class="highlighted"><code class="avrasm">new Foo()(<span class="string">"one"</span>)(<span class="string">"two"</span>)(<span class="string">"three"</span>)<span class="preprocessor">.Bar</span>()<span class="comment">; </span></code></pre>
<p>That looks somewhat better doesn&#39;t it? Sure we&#39;re using <code>()</code> not <code>[]</code>, but that&#39;s minor semantics really, the question is can we actually make that our API? Of course we can, and we&#39;ll have a look at how (if you guessed that you couldn&#39;t where did you think this post would go :P).</p>
<p>So you know that JavaScript functions are just objects right? Well they are and what&#39;s cool is that since they are just objects we can manipulate them as such. Let&#39;s start with foo, really foo is just a function (since we don&#39;t have classes in JavaScript):</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> foo = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
};</code></pre>
<p>Now, I&#39;m going to want something returned from foo that can be invoked like a function, so maybe I could just return a function...</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> foo = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> innerFoo = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    };

    <span class="keyword">return</span> innerFoo;
};</code></pre>
<p>Ok that&#39;s a good start, I can do:</p>
<pre class="highlighted"><code class="erlang"><span class="function"><span class="title">foo</span><span class="params">()</span><span class="params">()</span>;</code></pre>
<p>Next it&#39;s time to make innerFoo do something, basically what innerFoo should do setup the next level down our chain. To keep the function more readable I&#39;m going to push the logic out into a new function, we&#39;ll call it next:</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> foo = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> innerFoo = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">return</span> next.apply(<span class="keyword">this</span>, arguments);
    };

    <span class="keyword">var</span> next = <span class="function"><span class="keyword">function</span> <span class="params">(stuff)</span> {</span>
    };

    <span class="keyword">return</span> innerFoo;
};</code></pre>
<p>Do you see where we&#39;re going here? The next method is ultimately going to be smart, setting up the next level down our object, whereas the innerFoo is really just a pass-through to that (it&#39;ll be clearer as we implement our next method):</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> foo = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> innerFoo = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">return</span> next.apply(<span class="keyword">this</span>, arguments);
    };

    <span class="keyword">var</span> next = <span class="function"><span class="keyword">function</span> <span class="params">(stuff)</span> {</span>
        <span class="keyword">var</span> child = foo();
        child.stuff = stuff;
        <span class="keyword">return</span> child;
    };

    <span class="keyword">return</span> innerFoo;
};</code></pre>
<p>So our next method will:</p>
<ul>
<li>Create a new foo function (well, a new innerFoo)</li>
<li>Create a property on the function object called stuff</li>
<li>Return the newly created object</li>
</ul>
<p>This means that we can do this:</p>
<pre class="highlighted"><code class="rust">console.<span class="keyword">log</span>(foo()(<span class="string">'one'</span>).stuff); <span class="comment">// one</span></code></pre>
<p>Or go further:</p>
<pre class="highlighted"><code class="rust">console.<span class="keyword">log</span>(foo()(<span class="string">'one'</span>)(<span class="string">'two'</span>).stuff); <span class="comment">// two</span></code></pre>
<p>Awesome, we&#39;ve pretty much got indexers going, now let&#39;s add the bar method from our original API.</p>
<pre class="highlighted"><code class="delphi"><span class="keyword">var</span> bar = <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="comment">{
    console.log('Darn tootin\'');
    return this;
}</span>

<span class="title">innerFoo</span>.<span class="title">bar</span> = <span class="title">bar</span>;</span></code></pre>
<p>Remember how I mentioned that functions as objects? Well this is where it can be really useful, since it&#39;s an object we can modify it like any JavaScript object and just add methods and properties like we&#39;ve done, and awesomely since we&#39;re going back through our original foo method it&#39;ll work with all the children we get.</p>
<h2>Parent access</h2>
<p>Once I did the initial revision for Luke he wasn&#39;t satisfied, next up he wanted to know how to access the parent of each instance created. Well that&#39;s actually pretty easy, just a small modification to our innerFoo function:</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> innerFoo = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> next.apply(innerFoo, arguments);
};</code></pre>
<p>So this time when it invokes the next level down will have a this context which is the parent object, then you can decide how to expose that as you step down.</p>
<h2>Bonus round – displaying the object</h2>
<p>If you&#39;ve run the code and tried to do a <code>console.log/console.dir</code> of the foo instances returned you&#39;ll see they are well... crappy:</p>
<pre class="highlighted"><code class="erlang"><span class="function"><span class="title">function</span> <span class="params">()</span> {
    <span class="title">return</span> <span class="title">next</span>.<span class="title">apply</span><span class="params">(inner<span class="variable">Foo</span>, arguments)</span>;
};</code></pre>
<p>Well that&#39;s kinda crappy, can&#39;t exactly see what the value of stuff is, or what an object&#39;s parent is now can we? Guess we better fix that!</p>
<p>Did you know that Object has a toString method on it? This method is generally overlooked, if you&#39;re working with an object you&#39;ll likely get [object Object] when you invoke it from your object, functions will return the text content of the function (which can be useful if you want to modify functions on the fly, but that&#39;s a subject for another day :P), and this is why we get the above output from foo, foo is a function after all.</p>
<p>Well we can write our own toString method if we want, we just put it on our object and it&#39;ll be used rather than the one inherited from the prototype chain. So let&#39;s do this:</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> toString = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.stuff;
};
innerFoo.toString = toString;</code></pre>
<p>Awesome, done! One thing to keep in mind is that <code>toString</code> must return a string value, it can do whatever you want to get there, just return a string ;).</p>
<p>But let&#39;s go one step further and exploit this, let&#39;s get it to output the whole parent graph, I&#39;m going to do this by using bind, like we saw in <a href="/posts/2013-07-05-javascript-binding-currying-and-arrows.html">my last post</a>:</p>
<pre class="highlighted"><code class="avrasm">var next = function (stuff) {
    var child = foo()<span class="comment">;</span>
    child<span class="preprocessor">.stuff</span> = stuff<span class="comment">;</span>
    child<span class="preprocessor">.toString</span> = toString<span class="preprocessor">.bind</span>(child, this)<span class="comment">;</span>
    return child<span class="comment">;</span>
}<span class="comment">;</span>

o<span class="preprocessor">.toString</span> = toString<span class="preprocessor">.bind</span>(o, null)<span class="comment">;</span></code></pre>
<p>You&#39;ll also see that I&#39;ve bound the parent as the first argument of <code>toString</code>. <code>toString</code> doesn&#39;t take arguments but by using bind we can do that, now let&#39;s update our toString method to handle it:</p>
<pre class="highlighted"><code class="php"><span class="keyword">var</span> toString = <span class="function"><span class="keyword">function</span> <span class="params">(parent)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">parent</span> + <span class="string">', '</span> + <span class="keyword">this</span>.stuff;
};</code></pre>
<p>Nifty huh? We&#39;re exploiting the type coercion in JavaScript, because parent isn&#39;t a string, it&#39;s an object, but we&#39;re using the + operator against another string JavaScript will coerce the object to a string, using its toString method, which in turn invokes the function we wrote, which in turn does coercion and so on!</p>
<h2>Done!</h2>
<p>And with that we wrap up this week&#39;s adventure, if you&#39;ve made it this far well done it was a long one but damn it was fun!</p>

                        </article>
                    </div>
                    <div class="8u skel-cell-mainContent">
                        <article class="is-post">
                            <div id="disqus_thread"></div>
<script>
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
window.disqus_shortname = 'aaronpowell'; // required: replace example with your forum shortname
window.disqus_identifier = document.title || 'Home';
window.disqus_developer = !! ~document.location.href.indexOf("localhost") ? 1 : 0;
window.disqus_url = document.location.origin + '/posts/2013-07-10-implementing-indexers-in-javascript.html';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by</a>
<span class="logo-disqus"> Disqus</span>

                        </article>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer-wrapper">

    <!-- Copyright -->
        <div id="copyright" class="container">
            <ul class="links">
                <li>&copy; Aaron Powell. All rights reserved</li>
                <li>Design: <a href="http://html5up.net/">HTML5 UP</a></li>
            </ul>
        </div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6399564-1']);
  _gaq.push(['_trackPageview']);

  (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>

    </body>
</html>